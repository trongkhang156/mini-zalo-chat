<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini Zalo Chat üí¨</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f1f1f1;
      margin: 0;
      display: flex;
      height: 100vh;
    }
    #user-list {
      width: 250px;
      background: white;
      border-right: 1px solid #ccc;
      overflow-y: auto;
    }
    #user-list h3 {
      background: #0078ff;
      color: white;
      margin: 0;
      padding: 10px;
      text-align: center;
    }
    #users {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    #users li {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #users li:hover {
      background: #e6f0ff;
    }
    #chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #chat-box {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #fafafa;
    }
    #chat-input {
      display: flex;
      border-top: 1px solid #ccc;
      background: white;
    }
    #chat-input input {
      flex: 1;
      padding: 10px;
      border: none;
      outline: none;
    }
    #chat-input button {
      padding: 10px 20px;
      border: none;
      background: #0078ff;
      color: white;
      cursor: pointer;
    }
    .msg {
      margin: 5px 0;
    }
    .msg strong {
      color: #0078ff;
    }
    .system {
      color: gray;
      font-style: italic;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="user-list">
    <h3>üë• Ng∆∞·ªùi d√πng</h3>
    <ul id="users"></ul>
  </div>

  <div id="chat-area">
    <div id="chat-box"></div>
    <div id="chat-input">
      <input id="message" placeholder="Nh·∫≠p tin nh·∫Øn..." />
      <button id="sendBtn">G·ª≠i</button>
    </div>
  </div>

  <script>
    // üîπ K·∫øt n·ªëi t·ªõi server
    const socket = io();
    let username = "";
    let selectedUser = null;

    // üîπ ƒêƒÉng k√Ω Service Worker (ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o n·ªÅn)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js").then(() => {
        console.log("‚úÖ Service Worker ƒë√£ ƒëƒÉng k√Ω");
      });
    }

    // üîπ Xin quy·ªÅn g·ª≠i th√¥ng b√°o
    Notification.requestPermission().then((perm) => {
      if (perm !== "granted") {
        Swal.fire("‚ö†Ô∏è H√£y b·∫≠t quy·ªÅn th√¥ng b√°o ƒë·ªÉ nh·∫≠n tin nh∆∞ Zalo!");
      }
    });

    // üîπ Nh·∫≠p t√™n
    Swal.fire({
      title: "Nh·∫≠p t√™n c·ªßa b·∫°n",
      input: "text",
      inputPlaceholder: "VD: khang123",
      allowOutsideClick: false,
      confirmButtonText: "V√†o chat"
    }).then((result) => {
      username = result.value.trim();
      if (!username) location.reload();
      socket.emit("register", username);
    });

    // üîπ Danh s√°ch ng∆∞·ªùi d√πng
    socket.on("users", (list) => {
      const usersEl = document.getElementById("users");
      usersEl.innerHTML = "";
      list.forEach((u) => {
        if (u === username) return;
        const li = document.createElement("li");
        li.textContent = u;
        li.onclick = () => {
          selectedUser = u;
          document.getElementById("chat-box").innerHTML += `<div class="system">üí¨ ƒêang chat v·ªõi <b>${u}</b></div>`;
        };
        usersEl.appendChild(li);
      });
    });

    // üîπ G·ª≠i tin nh·∫Øn
    document.getElementById("sendBtn").onclick = () => {
      const msg = document.getElementById("message").value.trim();
      if (!msg || !selectedUser) return;
      socket.emit("private message", { to: selectedUser, message: msg });
      addMessage(username, msg);
      document.getElementById("message").value = "";
    };

    // üîπ Nh·∫≠n tin nh·∫Øn
    socket.on("private message", ({ from, message }) => {
      addMessage(from, message);
      showDesktopNotification(from, message);
    });

    // üîπ Th√™m tin nh·∫Øn
    function addMessage(from, message) {
      const chatBox = document.getElementById("chat-box");
      const div = document.createElement("div");
      div.classList.add("msg");
      div.innerHTML = `<strong>${from}:</strong> ${message}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // üîπ Hi·ªÉn th·ªã th√¥ng b√°o desktop (Zalo-style)
    function showDesktopNotification(from, message) {
      if (Notification.permission === "granted") {
        navigator.serviceWorker.ready.then((reg) => {
          reg.showNotification(`üí¨ Tin nh·∫Øn m·ªõi t·ª´ ${from}`, {
            body: message,
            icon: "https://cdn-icons-png.flaticon.com/512/906/906349.png",
            badge: "https://cdn-icons-png.flaticon.com/512/906/906349.png",
          });
        });
      }
    }
  </script>
</body>
</html>
