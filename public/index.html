<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mini Zalo Chat</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root {
  --blue: #0084ff;
  --light: #f5f6f8;
  --self: #dcf8c6;
  --other: #fff;
}

body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: var(--light);
}

.chat-container {
  width: 90vw;       /* chi·∫øm 90% chi·ªÅu ngang */
  max-width: 320px;  /* gi·ªõi h·∫°n tr√™n desktop */
  height: 70vh;      /* cao 70% viewport height */
  position: fixed;
  bottom: env(safe-area-inset-bottom, 20px); /* tr√°nh footer iOS */
  right: env(safe-area-inset-right, 20px);
  left: env(safe-area-inset-left, auto);
  background: #fff;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  overflow: hidden;
  z-index: 1000;
}

/* Header */
#chat-header {
  background: var(--blue);
  color: #fff;
  padding: 8px 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Users list */
#users-list {
  background: #f8f9fa;
  border-bottom: 1px solid #ddd;
  padding: 6px 10px;
  display: flex;
  overflow-x: auto;
  gap: 6px;
}

#users-list div {
  background: #e7f0ff;
  padding: 5px 8px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 13px;
  white-space: nowrap;
}

#users-list .active {
  background: var(--blue);
  color: #fff;
}

#messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  margin-bottom: env(safe-area-inset-bottom, 0); /* tr√°nh b·ªã che input */
}

/* Form nh·∫≠p tin nh·∫Øn lu√¥n hi·ªÉn th·ªã tr√™n mobile */
#msg-form {
  display: flex;
  padding: 6px;
  border-top: 1px solid #ddd;
  background: #fff;
  position: sticky;
  bottom: 0;
}

.msg {
  max-width: 75%;
  padding: 6px 10px;
  border-radius: 12px;
  margin-bottom: 6px;
  word-wrap: break-word;
  font-size: 14px;
}

.msg.self { background: var(--self); align-self: flex-end; }
.msg.other { background: var(--other); align-self: flex-start; border: 1px solid #ddd; }



#msg-input {
  flex: 1;
  padding: 8px;
  border-radius: 20px;
  border: 1px solid #ccc;
  outline: none;
}

#msg-form button {
  margin-left: 5px;
  border-radius: 20px;
  padding: 8px 12px;
  border: none;
  background: var(--blue);
  color: #fff;
  cursor: pointer;
}

/* Responsive */
@media (max-width: 600px) {
  .chat-container {
    width: 100%;
    height: 100vh;
    border-radius: 0;
    bottom: 0;
    right: 0;
  }
}
</style>
</head>
<body>

<div class="chat-container">
  <div id="chat-header">
    <span id="me-name">Mini Zalo</span>
    <button id="rename-btn" style="border:none;background:rgba(255,255,255,0.3);color:#fff;border-radius:6px;padding:2px 6px;">ƒê·ªïi</button>
  </div>

  <div id="users-list"></div>
  <div id="messages"></div>

  <form id="msg-form">
    <input id="msg-input" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off"/>
    <button type="button" id="send-btn">G·ª≠i</button>
  </form>
</div>

<script>
const socket = io("https://mini-zalo-chat.onrender.com", { transports: ["websocket"] });
let username = localStorage.getItem("chat_username") || `User${Math.floor(Math.random()*1000)}`;
localStorage.setItem("chat_username", username);
document.getElementById("me-name").textContent = username;

let currentChat = null;

// Service Worker & Notification
if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
Notification.requestPermission();

socket.emit("register", username);

// Update user list
socket.on("users", users => {
  const list = document.getElementById("users-list");
  list.innerHTML = '';
  users.forEach(u => {
    if (u === username) return;
    const div = document.createElement("div");
    div.textContent = u;
    if (u === currentChat) div.classList.add("active");
    div.onclick = () => {
      currentChat = u;
      document.querySelectorAll("#users-list div").forEach(el => el.classList.remove("active"));
      div.classList.add("active");
      document.getElementById("messages").innerHTML = '';
    };
    list.appendChild(div);
  });
});

// Send message
const msgInput = document.getElementById("msg-input");
const sendBtn = document.getElementById("send-btn");

sendBtn.onclick = sendMessage;
msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function sendMessage() {
  const msg = msgInput.value.trim();
  if(!msg || !currentChat) return Swal.fire("Ch∆∞a ch·ªçn ng∆∞·ªùi ƒë·ªÉ chat!", "", "info");
  socket.emit("private message", { to: currentChat, message: msg });
  addMessage("T√¥i", msg, "self");
  msgInput.value = '';
}

socket.on("private message", ({ from, message }) => {
  addMessage(from, message, "other");
  showNotification(from, message);
});

function addMessage(from, msg, type) {
  const box = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = "msg " + type;
  div.textContent = `${from}: ${msg}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function showNotification(from, message) {
  if(Notification.permission === 'granted'){
    navigator.serviceWorker.ready.then(reg => {
      reg.showNotification(`üí¨ Tin nh·∫Øn m·ªõi t·ª´ ${from}`, { body: message, icon: "https://cdn-icons-png.flaticon.com/512/906/906349.png" });
    });
  }
}

// Rename
document.getElementById("rename-btn").onclick = () => {
  Swal.fire({
    title: "ƒê·ªïi t√™n",
    input: "text",
    inputValue: username,
    showCancelButton: true,
    confirmButtonText: "OK"
  }).then(res => {
    if(res.value){
      username = res.value.trim();
      localStorage.setItem("chat_username", username);
      document.getElementById("me-name").textContent = username;
      socket.emit("register", username);
    }
  });
};
</script>
</body>
</html>
