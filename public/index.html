<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Mini Zalo Chat</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0084ff">

<style>
:root {
  --blue: #0084ff;
  --light: #f5f6f8;
  --self: #dcf8c6;
  --other: #fff;
}

/* Reset */
* { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: var(--light);
  font-family: "Segoe UI", Arial, sans-serif;
  overscroll-behavior: none;
}

/* Container ch√≠nh */
.chat-container {
  width: 400px;
  max-width: 100vw;
  height: 100dvh; /* d√πng ƒë∆°n v·ªã m·ªõi, ·ªïn ƒë·ªãnh khi b√†n ph√≠m b·∫≠t */
  background: #fff;
  border-radius: 0;
  display: flex;
  flex-direction: column;
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  overflow: hidden;
  position: fixed;
  inset: 0;
}

/* Header */
#chat-header {
  background: var(--blue);
  color: #fff;
  padding: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
  font-size: 18px;
}

#rename-btn {
  border: none;
  background: rgba(255,255,255,0.3);
  color: #fff;
  border-radius: 8px;
  padding: 5px 10px;
  font-size: 14px;
  cursor: pointer;
}

/* Users list */
#users-list {
  display: flex;
  overflow-x: auto;
  gap: 8px;
  padding: 10px;
  border-bottom: 1px solid #ddd;
  background: #f8f9fa;
  flex-shrink: 0;
}

#users-list div {
  background: #e7f0ff;
  padding: 8px 12px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 15px;
  white-space: nowrap;
  user-select: none;
  transition: all 0.2s;
}

#users-list div:hover {
  background: #d0e2ff;
}

#users-list .active {
  background: var(--blue);
  color: #fff;
}

/* Messages */
#messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: var(--light);
}

/* Input form */
#msg-form {
  display: flex;
  padding: 8px;
  border-top: 1px solid #ddd;
  background: #fff;
  position: sticky;
  bottom: 0;
  z-index: 10;
  padding-bottom: calc(8px + env(safe-area-inset-bottom)); /* ch·ª´a v√πng safe-area cho mobile */
}

#msg-input {
  flex: 1;
  padding: 10px;
  border-radius: 20px;
  border: 1px solid #ccc;
  outline: none;
  font-size: 16px;
}

#send-btn {
  margin-left: 6px;
  border-radius: 20px;
  padding: 10px 16px;
  border: none;
  background: var(--blue);
  color: #fff;
  cursor: pointer;
  font-size: 16px;
  transition: 0.2s;
}
#send-btn:active {
  transform: scale(0.95);
}

/* Message bubble */
.msg {
  max-width: 80%;
  padding: 8px 12px;
  border-radius: 12px;
  word-wrap: break-word;
  font-size: 15px;
}
.msg.self {
  background: var(--self);
  align-self: flex-end;
}
.msg.other {
  background: var(--other);
  align-self: flex-start;
  border: 1px solid #ddd;
}

/* Mobile tweaks */
@media (max-width: 600px) {
  .chat-container {
    border-radius: 0;
    height: 100dvh;
  }

  #chat-header {
    font-size: 16px;
  }

  #msg-input {
    font-size: 15px;
  }

  #users-list div {
    font-size: 14px;
    padding: 6px 10px;
  }
}
</style>
</head>
<body>

<div class="chat-container">
  <div id="chat-header">
    <span id="me-name">Mini Zalo</span>
    <button id="rename-btn">ƒê·ªïi t√™n</button>
  </div>

  <div id="users-list"></div>
  <div id="messages"></div>

  <form id="msg-form" onsubmit="return false;">
    <input id="msg-input" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off" />
    <button type="button" id="send-btn">G·ª≠i</button>
  </form>
</div>

<script>
const socket = io("https://mini-zalo-chat.onrender.com", { transports: ["websocket"] });
let username = localStorage.getItem("chat_username") || `User${Math.floor(Math.random()*1000)}`;
localStorage.setItem("chat_username", username);
document.getElementById("me-name").textContent = username;
let currentChat = null;

// Service Worker + th√¥ng b√°o
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('/sw.js');
      console.log("Service Worker registered", reg);

      if (Notification.permission !== 'granted') {
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') {
          alert('B·∫°n c·∫ßn b·∫≠t th√¥ng b√°o ƒë·ªÉ nh·∫≠n tin nh·∫Øn.');
        }
      }
    } catch (err) {
      console.error("SW registration failed", err);
    }
  });
}

socket.emit("register", username);

// Danh s√°ch user
socket.on("users", users => {
  const list = document.getElementById("users-list");
  list.innerHTML = '';
  users.forEach(u => {
    if (u === username) return;
    const div = document.createElement("div");
    div.textContent = u;
    if (u === currentChat) div.classList.add("active");
    div.onclick = () => {
      currentChat = u;
      document.querySelectorAll("#users-list div").forEach(el => el.classList.remove("active"));
      div.classList.add("active");
      document.getElementById("messages").innerHTML = '';
    };
    list.appendChild(div);
  });
});

// G·ª≠i tin nh·∫Øn
const msgInput = document.getElementById("msg-input");
const sendBtn = document.getElementById("send-btn");
sendBtn.onclick = sendMessage;
msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function sendMessage() {
  const msg = msgInput.value.trim();
  if (!msg || !currentChat) {
    Swal.fire("Ch∆∞a ch·ªçn ng∆∞·ªùi ƒë·ªÉ chat!", "", "info");
    return;
  }
  socket.emit("private message", { to: currentChat, message: msg });
  addMessage("T√¥i", msg, "self");
  msgInput.value = '';
}

socket.on("private message", ({ from, message }) => {
  addMessage(from, message, "other");
  showNotification(from, message);
});

function addMessage(from, msg, type) {
  const box = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = "msg " + type;
  div.textContent = `${from}: ${msg}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function showNotification(from, message) {
  if (Notification.permission === 'granted') {
    navigator.serviceWorker.ready.then(reg => {
      reg.showNotification(`üí¨ Tin nh·∫Øn m·ªõi t·ª´ ${from}`, {
        body: message,
        icon: "https://cdn-icons-png.flaticon.com/512/906/906349.png"
      });
    });
  }
}

// ƒê·ªïi t√™n
document.getElementById("rename-btn").onclick = () => {
  Swal.fire({
    title: "ƒê·ªïi t√™n",
    input: "text",
    inputValue: username,
    showCancelButton: true,
    confirmButtonText: "OK"
  }).then(res => {
    if (res.value) {
      username = res.value.trim();
      localStorage.setItem("chat_username", username);
      document.getElementById("me-name").textContent = username;
      socket.emit("register", username);
    }
  });
};

// üîß Fix viewport nh·∫£y khi m·ªü b√†n ph√≠m
const messages = document.getElementById("messages");
window.visualViewport?.addEventListener("resize", () => {
  messages.scrollTop = messages.scrollHeight;
});
</script>
</body>
</html>
